{"version":3,"sources":["../../src/server/WiggleServerEngine.js"],"names":["WiggleServerEngine","io","gameEngine","inputOptions","on","stepLogic","bind","f","foodCount","newF","Food","position","randPos","addObjectToWorld","newAI","Wiggle","AI","direction","turnDirection","bodyLength","startBodyLength","playerId","friendlyName","Math","floor","random","socket","player","socketId","playerWiggle","world","queryObject","removeObjectFromWorld","id","w","objects","w1","w2","wiggles","queryObjects","instanceType","foodObjects","i","bodyParts","length","distance","clone","subtract","collideDistance","wiggleHitWiggle","eatDistance","wiggleEatFood","y","spaceHeight","PI","x","spaceWidth","ServerEngine"],"mappings":"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","sourcesContent":["import { ServerEngine } from 'lance-gg';\nimport Wiggle from '../common/Wiggle';\nimport Food from '../common/Food';\n\nexport default class WiggleServerEngine extends ServerEngine {\n\n    constructor(io, gameEngine, inputOptions) {\n        super(io, gameEngine, inputOptions);\n        this.gameEngine.on('postStep', this.stepLogic.bind(this));\n    }\n\n    // create food and AI robots\n    start() {\n        super.start();\n        for (let f = 0; f < this.gameEngine.foodCount; f++) {\n            let newF = new Food(this.gameEngine, null, { position: this.gameEngine.randPos() });\n            this.gameEngine.addObjectToWorld(newF);\n        }\n        /* for (let ai = 0; ai < this.gameEngine.aiCount; ai++)\n            this.addAI(); */\n    }\n\n    addAI() {\n        let newAI = new Wiggle(this.gameEngine, null, { position: this.gameEngine.randPos() });\n        newAI.AI = true;\n        newAI.direction = 0;\n        newAI.turnDirection = 1;\n        newAI.bodyLength = this.gameEngine.startBodyLength;\n        newAI.playerId = 0;\n        newAI.friendlyName = \"Baddie #\" + (Math.floor(Math.random()*100));\n        this.gameEngine.addObjectToWorld(newAI);\n    }\n\n    onPlayerConnected(socket) {\n        super.onPlayerConnected(socket);\n        let player = new Wiggle(this.gameEngine, null, { position: this.gameEngine.randPos() });\n        player.direction = 0;\n        player.bodyLength = this.gameEngine.startBodyLength;\n        player.playerId = socket.playerId;\n        player.friendlyName = \"Rando #\" + (Math.floor(Math.random()*100));\n        this.gameEngine.addObjectToWorld(player);\n    }\n\n    onPlayerDisconnected(socketId, playerId) {\n        super.onPlayerDisconnected(socketId, playerId);\n        let playerWiggle = this.gameEngine.world.queryObject({ playerId });\n        if (playerWiggle) this.gameEngine.removeObjectFromWorld(playerWiggle.id);\n    }\n\n    // Eating Food:\n    // increase body length, and remove the food\n    wiggleEatFood(w, f) {\n        if (!(f.id in this.gameEngine.world.objects))\n            return;\n\n        w.bodyLength++;\n        this.gameEngine.removeObjectFromWorld(f);\n        let newF = new Food(this.gameEngine, null, { position: this.gameEngine.randPos() });\n        this.gameEngine.addObjectToWorld(newF);\n    }\n\n    wiggleHitWiggle(w1, w2) {\n        if (!(w2.id in this.gameEngine.world.objects) || !(w1.id in this.gameEngine.world.objects))\n            return;\n\n        this.gameEngine.removeObjectFromWorld(w1);\n        //if (w1.AI) this.addAI();\n    }\n\n    stepLogic() {\n        let wiggles = this.gameEngine.world.queryObjects({ instanceType: Wiggle });\n        let foodObjects = this.gameEngine.world.queryObjects({ instanceType: Food });\n        for (let w of wiggles) {\n\n            // check for collision\n            for (let w2 of wiggles) {\n                if (w === w2)\n                    continue;\n\n                for (let i = 0; i < w2.bodyParts.length; i++) {\n                    let distance = w2.bodyParts[i].clone().subtract(w.position);\n                    if (distance.length() < this.gameEngine.collideDistance)\n                        this.wiggleHitWiggle(w, w2);\n                }\n            }\n\n            // check for food-eating\n            for (let f of foodObjects) {\n                let distance = w.position.clone().subtract(f.position);\n                if (distance.length() < this.gameEngine.eatDistance) {\n                    this.wiggleEatFood(w, f);\n                }\n            }\n\n            // move AI wiggles\n            if (w.AI) {\n                if (Math.random() < 0.01) w.turnDirection *= -1;\n                w.direction += w.turnDirection * (Math.random() - 0.9)/20;\n                if (w.position.y >= this.gameEngine.spaceHeight / 2) w.direction = -Math.PI/2;\n                if (w.position.y <= -this.gameEngine.spaceHeight / 2) w.direction = Math.PI/2;\n                if (w.position.x >= this.gameEngine.spaceWidth / 2) w.direction = Math.PI;\n                if (w.position.x <= -this.gameEngine.spaceWidth / 2) w.direction = 0;\n                if (w.direction > Math.PI * 2) w.direction -= Math.PI * 2;\n                if (w.direction < 0) w.direction += Math.PI * 2;\n            }\n        }\n    }\n}\n"],"file":"WiggleServerEngine.js"}